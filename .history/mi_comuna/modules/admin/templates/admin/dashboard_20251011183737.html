{% extends "admin/base_admin.html" %}

{% block header %}📊 Panel General{% endblock %}

{% block content %}
<section class="max-w-7xl mx-auto px-6 py-10 space-y-10">

  <!-- 🔹 Encabezado -->
  <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
    <div>
      <h1 class="text-3xl font-extrabold text-gray-900 flex items-center gap-2">
        🧭 Panel de Control General
      </h1>
      <p class="text-gray-600 mt-1">Resumen global de la actividad en el portal.</p>
    </div>
    <div class="bg-gray-100 px-4 py-2 rounded-lg text-sm text-gray-700 shadow-sm">
      Última actualización:
      <strong>{{ now().strftime("%d/%m/%Y %H:%M") }}</strong>
    </div>
  </div>

  <!-- 🔹 Métricas principales -->
  <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">
    {% set metricas = [
      {"valor": usuarios, "label": "Usuarios registrados", "color": "blue", "icon": "👥"},
      {"valor": aprobados, "label": "Negocios activos", "color": "green", "icon": "🏢"},
      {"valor": pendientes, "label": "Negocios pendientes", "color": "yellow", "icon": "⏳"},
      {"valor": categorias, "label": "Categorías registradas", "color": "purple", "icon": "🗂️"},
      {"valor": noticias, "label": "Noticias publicadas", "color": "red", "icon": "📰"},
      {"valor": avisos_activos, "label": "Avisos activos", "color": "indigo", "icon": "📢"}
    ] %}
    {% for m in metricas %}
    <div class="bg-white p-5 rounded-xl shadow hover:shadow-lg transition border-l-4 border-{{m.color}}-500">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-gray-500 text-sm">{{ m.label }}</p>
          <h2 class="text-3xl font-extrabold text-gray-800 mt-2">{{ m.valor }}</h2>
        </div>
        <span class="text-2xl">{{ m.icon }}</span>
      </div>
    </div>
    {% endfor %}
  </div>

  <!-- 🔹 Negocios recientes -->
  <div class="bg-white rounded-xl shadow overflow-hidden">
    <div class="flex justify-between items-center px-6 py-4 border-b">
      <h2 class="text-lg font-bold text-gray-800 flex items-center gap-2">🏢 Negocios recientes</h2>
      <a href="{{ url_for('admin.admin_negocios') }}"
         class="text-blue-600 hover:text-blue-800 font-semibold text-sm">Ver todos →</a>
    </div>

    {% if negocios %}
      <div class="overflow-x-auto">
        <table class="min-w-full text-sm text-left">
          <thead class="bg-gray-50 text-gray-600 uppercase text-xs">
            <tr>
              <th class="px-6 py-3">Negocio</th>
              <th class="px-6 py-3">Categoría</th>
              <th class="px-6 py-3">Estado</th>
              <th class="px-6 py-3 text-right">Acciones</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-200">
            {% for n in negocios %}
            <tr class="hover:bg-gray-50 transition">
              <td class="px-6 py-4 flex items-center gap-3">
                <img src="{{ n.imagen if n.imagen else url_for('static', filename='img/default_business.png') }}"
                     class="h-10 w-10 rounded-lg object-cover border shadow-sm"
                     alt="{{ n.nombre }}">
                <div>
                  <p class="font-semibold text-gray-800">{{ n.nombre }}</p>
                  <p class="text-xs text-gray-500">{{ n.descripcion|truncate(50, True, '…') }}</p>
                </div>
              </td>
              <td class="px-6 py-4 text-gray-700">
                {{ n.categoria.nombre if n.categoria else "—" }}
              </td>
              <td class="px-6 py-4">
                {% if n.estado == "aprobado" %}
                  <span class="px-2 py-1 bg-green-100 text-green-700 rounded-full text-xs font-semibold">Aprobado</span>
                {% elif n.estado == "pendiente" %}
                  <span class="px-2 py-1 bg-yellow-100 text-yellow-700 rounded-full text-xs font-semibold">Pendiente</span>
                {% else %}
                  <span class="px-2 py-1 bg-gray-100 text-gray-600 rounded-full text-xs font-semibold">{{ n.estado }}</span>
                {% endif %}
              </td>
              <td class="px-6 py-4 text-right space-x-2">
                {% if n.estado == "pendiente" %}
                  <form action="{{ url_for('admin.aprobar_negocio', id=n.id) }}" method="POST" class="inline">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button class="text-green-600 hover:underline font-semibold text-sm">✔ Aprobar</button>
                  </form>
                {% endif %}
                <form action="{{ url_for('admin.eliminar_negocio', id=n.id) }}" method="POST" class="inline"
                      onsubmit="return confirm('⚠️ ¿Seguro que deseas eliminar este negocio?');">
                  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                  <button class="text-red-600 hover:underline font-semibold text-sm">🗑 Eliminar</button>
                </form>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <div class="p-6 text-center text-gray-600">No hay negocios registrados todavía.</div>
    {% endif %}
  </div>

  <!-- 🔹 Actividad reciente -->
  <div class="grid md:grid-cols-2 gap-6 mt-10">
    <!-- Ciudadanos -->
    <div class="bg-white rounded-xl shadow p-6">
      <h3 class="text-lg font-bold text-gray-800 mb-3">🧑‍🤝‍🧑 Nuevos Ciudadanos</h3>
      {% if ultimos_usuarios %}
        <ul class="divide-y divide-gray-200">
          {% for u in ultimos_usuarios %}
            <li class="py-2 flex justify-between items-center">
              <span>{{ u.nombre }}</span>
              <span class="text-xs text-gray-500">
                {{ u.fecha_registro.strftime("%d/%m/%Y") if u.fecha_registro else "—" }}
              </span>
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <p class="text-gray-500 text-sm">No hay registros recientes.</p>
      {% endif %}
    </div>

    <!-- Noticias -->
    <div class="bg-white rounded-xl shadow p-6">
      <h3 class="text-lg font-bold text-gray-800 mb-3">📰 Últimas Noticias</h3>
      {% if ultimas_noticias %}
        <ul class="divide-y divide-gray-200">
          {% for n in ultimas_noticias %}
            <li class="py-2 flex justify-between items-center">
              <span>{{ n.titulo }}</span>
              <span class="text-xs text-gray-500">{{ n.fecha.strftime("%d/%m/%Y") }}</span>
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <p class="text-gray-500 text-sm">Aún no hay noticias recientes.</p>
      {% endif %}
    </div>
  </div>

</section>
{% endblock %}
